import { createWagmiTest, renderHook, waitFor } from '@morpho-org/test-wagmi'
import { parseEther, type PublicClient } from 'viem'
import { mainnet } from 'viem/chains'
import { describe, expect } from 'vitest'
import { useMintPlanPreview } from '@/features/leverage-tokens/hooks/mint/useMintPlanPreview'
import { useMintWrite } from '@/features/leverage-tokens/hooks/mint/useMintWrite'
import {
  LeverageTokenKey,
  leverageTokenConfigs,
} from '@/features/leverage-tokens/leverageTokens.config'
import { readLeverageTokenBalanceOf } from '@/lib/contracts/generated'
import { mainnetAddresses } from '../addresses'
import { createDebtToCollateralQuote } from '@/domain/mint/utils/createDebtToCollateralQuote'

const test_wsteth_eth_25x_lifi = createWagmiTest(mainnet, {
  forkUrl: process.env['VITE_ETHEREUM_RPC_URL'],
  forkBlockNumber: 24219436n,
})

describe('mint integration tests', () => {
  test_wsteth_eth_25x_lifi(
    'mints wsteth-eth-25x using lifi',
    async ({ client, config: wagmiConfig }) => {
      const leverageTokenConfig =
        leverageTokenConfigs[LeverageTokenKey.WSTETH_ETH_25X_ETHEREUM_MAINNET]
      if (!leverageTokenConfig) {
        throw new Error('Leverage token config not found')
      }

      // Fund the client account with 1 ETH and 1 wstETH
      await client.deal({
        erc20: leverageTokenConfig.collateralAsset.address,
        account: client.account.address,
        amount: parseEther('1'),
      })
      await client.setBalance({
        address: client.account.address,
        value: parseEther('1'),
      })

      const quoteFn = createDebtToCollateralQuote({
        chainId: mainnet.id,
        routerAddress: mainnetAddresses.leverageRouterV2,
        swap: { type: 'lifi', allowBridges: 'none', order: 'CHEAPEST' },
        getPublicClient: (cid: number) => (cid === mainnet.id ? client as unknown as PublicClient : undefined),
        fromAddress: mainnetAddresses.multicallExecutor,
      }).quote

      const equityInCollateralAsset = 10n ** 18n // 1 wstETH deposited by the user
      const { result: mintPlanPreviewResult } = renderHook(wagmiConfig, () =>
        useMintPlanPreview({
          config: wagmiConfig,
          token: leverageTokenConfig.address,
          equityInCollateralAsset,
          slippageBps: 100,
          chainId: mainnet.id,
          enabled: true,
          quote: quoteFn,
          debounceMs: 0,
        }),
      )
      await waitFor(() => expect(mintPlanPreviewResult.current.plan).toBeDefined())
      if (!mintPlanPreviewResult.current.plan) {
        throw new Error('Current plan not found')
      }
      const plan = mintPlanPreviewResult.current.plan

      expect(plan.minShares).toBe(952417000492971631n)
      expect(plan.minExcessDebt).toBe(6389842463548018n)
      expect(plan.previewShares).toBe(952809156689806197n)
      expect(plan.previewExcessDebt).toBe(11972742859077588n)
      expect(plan.flashLoanAmount).toBe(29077811172079415809n)
      expect(plan.equityInCollateralAsset).toBe(1000000000000000000n)
      expect(plan.calls).toEqual([
        {
          target: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',
          data: '0x095ea7b30000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000000000000000000000000001938923333dadb201',
          value: 0n,
        },
        {
          target: '0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE',
          data: '0x4666fc800c7a182bddeddc9bbe259345e49504c83b4e06c2adec7c3ee53aed5d477fa22000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000b0764de7eef0ac69855c431334b7bc51a96e6dba000000000000000000000000000000000000000000000001498cc6ea49c84a7f000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000087365616d6c657373000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000005e1f62dac767b0491e3ce72469c217365d5b48cc00000000000000000000000040aa958dd87fc8305b97f2ba922cddca374bcd7f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca0000000000000000000000000000000000000000000000001938923333dadb20100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000005240c307f760000000000000000000000000000000000000000000000000000000000019e120000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca0000000000000000000000000000000000000000000000001938923333dadb201000000000000000000000000000000000000000000000001498cc6ea49c84a7e0000000000000000000000000000000000000000000000000000000069651cf800000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000020000000000000000000000006747bcaf9bd5a5f0758cbe08903490e45ddfacb500000000000000000000000023007b443c46bb0fe46567be852d25f3a776917700000000000000000000000000000000000000000000000000000000000000020000000000000000000000006747bcaf9bd5a5f0758cbe08903490e45ddfacb500000000000000000000000023007b443c46bb0fe46567be852d25f3a7769177000000000000000000000000000000000000000000000000000000000000000280000000000000000001176f109830a1aaad605bbf02a9dfa7b0b92ec2fb7daa800000000000000000010fa180c37913149887310ff7f9c978856beae28f04e100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca0777777771111800000000000000000000000000000000001499da7417eb283f8777777771111000000000064fa00a9ed787f3793db668bff3e6e6e7db0f92a1b00000000000000000000000000000000000000000000000000000000',
          value: 0n,
        },
      ])

      // Approve the leverage router to spend the collateral asset
      await client.approve({
        address: leverageTokenConfig.collateralAsset.address,
        args: [mainnetAddresses.leverageRouterV2, equityInCollateralAsset],
      })

      const { result: mintWriteResult } = renderHook(wagmiConfig, () => useMintWrite())
      await waitFor(() => expect(mintWriteResult.current.mutateAsync).toBeDefined())

      await mintWriteResult.current.mutateAsync({
        config: wagmiConfig,
        chainId: mainnet.id,
        account: client.account,
        token: leverageTokenConfig.address,
        plan: plan,
      })

      const sharesAfter = await readLeverageTokenBalanceOf(wagmiConfig, {
        address: leverageTokenConfig.address,
        args: [client.account.address],
      })
      expect(sharesAfter).toBeGreaterThanOrEqual(plan.minShares)
      expect(sharesAfter).toBe(952772571476942294n)
    },
  )
})
