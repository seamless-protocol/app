# Handoff 1 — 2025-08-20

Owner: <your-name>

## Scope
- Deterministic Base-fork testing for mint path.
- Test-mode wiring with wagmi `mock` connector.
- Integration test infra on Anvil; unit test stabilization.

## What Landed In This PR
- Test-only wagmi config (`src/lib/config/wagmi.config.test.ts`) using `mock` connector, HTTP to Anvil.
- App switches to test config when `VITE_TEST_MODE=mock` (`src/main.tsx`).
- Header renders `Connect (Mock)` button when in test mode (`src/components/ConnectButtonTest.tsx`, gated in `src/components/header.tsx`).
- Unit test bootstrap fix: added `leverageRouterAbi` to mocked exports in `tests/setup.ts` to prevent Vitest import failure.
- No E2E infra changes yet; CI workflows remain as-is.

## Current Status
- Lint/Typecheck: Expected to pass (local typecheck is clean).
- Unit tests: Expected to pass after ABI mock fix.
- Integration tests: Implemented and runnable locally with Anvil (not executed in CI yet).
- E2E tests: Existing navigation/specs run against RainbowKit; no Anvil bootstrap in CI yet.

## What’s Left (still in this PR if time allows)
- MintForm testability polish:
  - Add `data-testid` for amount, submit, expected/min shares, tx hash.
  - Safe decimal parsing (string → wei) to avoid float→bigint issues.
- Optional: Version pins for stability (wagmi 2.16.4, viem 2.34.0, rainbowkit 2.2.8, Playwright 1.55.0).

## Next PR — E2E Anvil + Mint Happy Path
- Playwright global setup to start Anvil if not up (`tests/e2e/global-setup.ts`).
- Update `playwright.config.ts`:
  - `globalSetup` reference.
  - `webServer.command` with `VITE_TEST_MODE=mock VITE_ANVIL_RPC_URL=http://127.0.0.1:8545`.
- Add mint E2E spec (`tests/e2e/mint-flow.spec.ts`): connect mock → input 1 → mint → assert expected/min shares and tx hash.
- CI `test-e2e` job:
  - Install Foundry (`foundry-rs/foundry-toolchain@v1`).
  - Provide `ANVIL_BASE_FORK_URL` secret/variable.

## How To Run Locally
1) Start Base fork:
   - `ANVIL_BASE_FORK_URL=<your_rpc> bun run anvil:base`
2) Integration tests:
   - `bun run test:integration` (uses `tests/integration/.env`).
3) E2E (current nav tests):
   - `bun run test:e2e` (no Anvil dependency yet).

## Risks & Notes
- Swap path realism: keep `maxSwapCost` generous for tests to avoid flaky liquidity.
- Token decimals: adjust amounts if moving to 6-decimals collateral.
- Address drift: contract addresses come from `tests/integration/.env`; keep them updated.

## Acceptance (for this PR)
- Unit tests green.
- Lint/Typecheck green.
- Integration tests runnable locally against Anvil.

