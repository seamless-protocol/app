# Handoff – Leverage Tokens Data & UI (2025-09-06)

This handoff summarizes recent changes to the leverage tokens data flow and UI, including multi-chain reads, skeleton loading, config-based caps, and type safety improvements.

## Branch & Scope

- Branch: `feat/leverage-token-supply-caps`
- Primary changes:
  - Multi-chain per-token reads for the table (no dependency on wallet chain)
  - Token details page shows live TVL (equity) and Total Collateral with USD + skeletons
  - Supply caps read from config (per token), not subgraph
  - Removed Total Collateral column from table
  - Partial-data badge in table if manager not configured on a chain
  - RPC mainnet fallback and typing cleanups

## What’s Implemented

1) Table Data
- File: `src/features/leverage-tokens/hooks/useLeverageTokensTableData.ts`
- For each configured token (from `leverageTokens.config.ts`):
  - Resolves `LeverageManager` via `getLeverageManagerAddress(cfg.chainId)`
  - Reads `[getLeverageTokenConfig, getLeverageTokenState, totalSupply]` with `chainId: cfg.chainId`
  - Computes TVL from `equity` (debt units) and optional `tvlUsd` using CoinGecko debt price
  - Uses `cfg.supplyCap` (token units)
  - No lending adapter reads (collateral column removed in table)

2) Token Details Page
- File: `src/routes/tokens.$chainId.$id.tsx`
- TVL stat:
  - Uses `useLeverageTokenState` (equity in debt units) and `useUsdPrices`
  - Shows `Skeleton` while state/prices load
- Total Collateral stat:
  - Uses `useLeverageTokenCollateral` (manager → lendingAdapter → `getCollateral`) and `useUsdPrices`
  - Shows `Skeleton` while collateral/prices load
- Risk/parameters panel: `useLeverageTokenDetailedMetrics` (5m stale)

3) Pricing & Caching
- CoinGecko fetcher: `src/lib/prices/coingecko.ts`
  - Chain mapping: `1 → ethereum`, `8453 → base`
- Batched price hooks: `useUsdPrices` / `useUsdPricesMultiChain`
  - Defaults: `staleTime = 15s`, `refetchInterval = 15s`
- On-chain state/collateral: `staleTime = 30s`, `refetchInterval = 30s`

4) UI & Stories
- `Skeleton` component: `src/components/ui/skeleton.tsx` + Storybook story (`src/stories/ui/skeleton.stories.tsx`)
- Detailed metrics loading skeletons added (`LeverageTokenDetailedMetrics`)
- Partial-data badge in table when manager is missing for a chain

5) Config & RPC
- Token config: `src/features/leverage-tokens/leverageTokens.config.ts`
  - Includes `supplyCap` in token units (e.g., weETH/WETH 17x = `150`)
- RPC config: `src/lib/config/wagmi.config.ts`
  - Base: `VITE_BASE_RPC_URL` (fallback `https://mainnet.base.org`)
  - Ethereum: `VITE_MAINNET_RPC_URL` or `VITE_ETHEREUM_RPC_URL` fallback

6) Types & Cleanups
- Removed `any`/casts in table/state/collateral hooks; use narrowed result typing
- Removed subgraph caps code (hooks/fetchers/queries) and unused GraphQL types
- Removed stale comments

## Verification Checklist

- Env:
  - `.env.local` has `VITE_WALLETCONNECT_PROJECT_ID`, `VITE_BASE_RPC_URL`, and `VITE_ETHEREUM_RPC_URL` (or `VITE_MAINNET_RPC_URL`)
  - Ensure `VITE_TEST_MODE` is not `mock` for live RPC
- Run:
  - `bun run dev` (app)
  - `bun run storybook` (visual checks for Skeleton and token card)
  - `bun run check:fix` (lint/format/typecheck)
  - `bun run build` (should pass locally)
- Table:
  - TVL and supply load quickly; on refresh within 30s, data appears from cache (no skeleton)
  - No “Total Collateral” column
  - Partial-data badge appears if a token’s manager isn’t configured for its chain
- Token page:
  - TVL shows debt units + USD; skeletons appear on true cold load
  - Total Collateral shows collateral units + USD; skeletons appear on true cold load
- Prices:
  - USD values update within ~15s cadence

## Notes / Intentional Behaviors

- TVL equals equity (debt units). Collateral is shown separately; these are not the same quantity
- React Query caching: skeletons only render when queries are actually loading (freshness windows: 30s/15s/5m)

## Follow-Ups (Optional)

- Decide if we want to display TVL in collateral units for parity with V1 UI while keeping equity semantics
- Consider per-asset price cadences (e.g., USDC slower than WETH) and/or visibility-aware polling
- Add a token-page “partial data” note similar to the table badge when a manager isn’t configured

## Files of Interest

- Hooks:
  - `src/features/leverage-tokens/hooks/useLeverageTokensTableData.ts`
  - `src/features/leverage-tokens/hooks/useLeverageTokenState.ts`
  - `src/features/leverage-tokens/hooks/useLeverageTokenCollateral.ts`
  - `src/features/leverage-tokens/hooks/useLeverageTokenDetailedMetrics.ts`
- Pages:
  - `src/routes/tokens.index.tsx`
  - `src/routes/tokens.$chainId.$id.tsx`
- UI:
  - `src/features/leverage-tokens/components/LeverageTokenTable.tsx`
  - `src/features/leverage-tokens/components/LeverageTokenDetailedMetrics.tsx`
  - `src/components/ui/skeleton.tsx`
- Pricing:
  - `src/lib/prices/coingecko.ts`
  - `src/lib/prices/useUsdPrices.ts`
- Config:
  - `src/features/leverage-tokens/leverageTokens.config.ts`
  - `src/lib/config/wagmi.config.ts`

