name: CI

on:
  push:
    branches: [main]
  workflow_dispatch:
  pull_request:
    # Run on all pull requests regardless of target branch

jobs:
  check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Generate route tree
        run: bunx @tanstack/router-cli generate --config vite.config.ts
      
      - name: Run checks (lint + typecheck)
        run: bun run check

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Generate route tree
        run: bunx @tanstack/router-cli generate --config vite.config.ts
      
      - name: Run unit tests
        run: bun run test:unit

  # test-e2e:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest

  #     - name: Install dependencies
  #       run: bun install --frozen-lockfile

  #     - name: Install Playwright browsers
  #       run: npx playwright install --with-deps

  #     - name: Install Foundry
  #       uses: foundry-rs/foundry-toolchain@v1
  #       with:
  #         version: stable

  #     - name: Start Anvil (Mainnet fork)
  #       run: |
  #         bun run anvil:mainnet &
  #         sleep 5
  #       env:
  #         VITE_ALCHEMY_API_KEY: ${{ secrets.VITE_ALCHEMY_API_KEY }}
  #         ANVIL_MAINNET_FORK_BLOCK: 23821277

  #     - name: Run E2E tests (Mainnet tokens, Anvil)
  #       run: bun run test:e2e
  #       env:
  #         VITE_WALLETCONNECT_PROJECT_ID: ${{ secrets.VITE_WALLETCONNECT_PROJECT_ID }}
  #         VITE_LIFI_API_KEY: ${{ secrets.VITE_LIFI_API_KEY }}
  #         VITE_LIFI_INTEGRATOR: seamless
  #         VITE_COINGECKO_API_URL: ${{ secrets.VITE_COINGECKO_API_URL }}
  #         VITE_INCLUDE_TEST_TOKENS: true

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 7

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    env:
      VITE_LIFI_INTEGRATOR: seamless

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Run integration tests
        run: bun run test:integration:new
        env:
          VITE_LIFI_API_KEY: ${{ secrets.VITE_LIFI_API_KEY }}
          VITE_LIFI_INTEGRATOR: seamless
          VITE_COINGECKO_API_URL: ${{ secrets.VITE_COINGECKO_API_URL }}
          VITE_BASE_FORK_RPC_URL: ${{ secrets.VITE_BASE_FORK_RPC_URL }}
          VITE_ETHEREUM_FORK_RPC_URL: ${{ secrets.VITE_ETHEREUM_FORK_RPC_URL }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [check, test-unit, test-integration]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Generate route tree
        run: bunx @tanstack/router-cli generate --config vite.config.ts
      
      - name: Build application
        run: bun run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: github.ref == 'refs/heads/main'
        with:
          name: dist
          path: dist/
          retention-days: 7
