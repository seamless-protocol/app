name: Deploy to IPFS

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      branch:
        description: 'Branch to build and deploy'
        required: true
        default: 'main'
        type: string
      pin-name:
        description: 'Custom name for the IPFS pin (optional)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build project
      run: bun run build
      env:
        VITE_WALLETCONNECT_PROJECT_ID: ${{ secrets.VITE_WALLETCONNECT_PROJECT_ID }}
        VITE_BASE_RPC_URL: ${{ secrets.VITE_BASE_RPC_URL }}
        VITE_ETHEREUM_RPC_URL: ${{ secrets.VITE_ETHEREUM_RPC_URL }}
        VITE_THEGRAPH_API_KEY: ${{ secrets.VITE_THEGRAPH_API_KEY }}
        VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
        VITE_COINGECKO_API_URL: ${{ secrets.VITE_COINGECKO_API_URL }}
        # Feature flags
        VITE_DISABLE_LEVERAGE_TOKENS: ${{ secrets.VITE_DISABLE_LEVERAGE_TOKENS }}
        VITE_DISABLE_VAULTS: ${{ secrets.VITE_DISABLE_VAULTS }}
        VITE_DISABLE_PORTFOLIO: ${{ secrets.VITE_DISABLE_PORTFOLIO }}
        VITE_DISABLE_ANALYTICS: ${{ secrets.VITE_DISABLE_ANALYTICS }}
        VITE_DISABLE_STAKING: ${{ secrets.VITE_DISABLE_STAKING }}
        VITE_DISABLE_GOVERNANCE: ${{ secrets.VITE_DISABLE_GOVERNANCE }}
        VITE_DISABLE_FEATURED_LEVERAGE_TOKENS: ${{ secrets.VITE_DISABLE_FEATURED_LEVERAGE_TOKENS }}
        VITE_DISABLE_AVAILABLE_REWARDS: ${{ secrets.VITE_DISABLE_AVAILABLE_REWARDS }}
        VITE_DISABLE_SEAM_STAKING: ${{ secrets.VITE_DISABLE_SEAM_STAKING }}

    - name: Install action dependencies
      run: |
        cd .github/actions/deploy-ipfs
        npm install

    - name: Deploy to IPFS
      uses: ./.github/actions/deploy-ipfs
      with:
        pinata-jwt: ${{ secrets.PINATA_JWT }}
        source-dir: './dist'
        pin-name: ${{ inputs.pin-name || format('Seamless Dapp - {0} - {1}', inputs.branch, github.sha) }}